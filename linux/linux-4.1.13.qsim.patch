From 71e7901d3bd90a2d55205dd5fe7ed7c04e48d543 Mon Sep 17 00:00:00 2001
From: Pranith Kumar <bobby.prani@gmail.com>
Date: Tue, 8 Dec 2015 13:57:13 -0500
Subject: [PATCH 1/1] Enable qsim to track process pids

Signed-off-by: Pranith Kumar <bobby.prani@gmail.com>
---
 arch/arm64/include/asm/mmu_context.h | 2 +-
 kernel/sched/core.c                  | 8 ++++++++
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/arch/arm64/include/asm/mmu_context.h b/arch/arm64/include/asm/mmu_context.h
index 8ec41e5..ac22f01 100644
--- a/arch/arm64/include/asm/mmu_context.h
+++ b/arch/arm64/include/asm/mmu_context.h
@@ -42,7 +42,7 @@ static inline void contextidr_thread_switch(struct task_struct *next)
 	"	msr	contextidr_el1, %0\n"
 	"	isb"
 	:
-	: "r" (task_pid_nr(next)));
+	: "r" (task_tgid_nr(next)));
 }
 #else
 static inline void contextidr_thread_switch(struct task_struct *next)
diff --git a/kernel/sched/core.c b/kernel/sched/core.c
index 4d870eb..14b493d 100644
--- a/kernel/sched/core.c
+++ b/kernel/sched/core.c
@@ -2302,6 +2302,14 @@ context_switch(struct rq *rq, struct task_struct *prev,
 {
 	struct mm_struct *mm, *oldmm;
 
+	// tell qsim the pid of the next task or that it is idle
+	if (IS_ENABLED(CONFIG_X86)) {
+		if (next == rq->idle)
+			asm("cpuid;\n"::"a"(0x1d1e1d1e));
+		else
+			asm("cpuid;\n"::"a"(0xc75c0000 | ((u16)(task_tgid_nr(next)))));
+	}
+
 	prepare_task_switch(rq, prev, next);
 
 	mm = next->mm;
-- 
2.6.3

